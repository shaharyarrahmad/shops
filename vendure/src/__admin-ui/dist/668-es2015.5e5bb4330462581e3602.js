"use strict";(self.webpackChunkvendure_admin_ui=self.webpackChunkvendure_admin_ui||[]).push([[668],{11668:function(e,t,i){i.r(t),i.d(t,{InvoicesModule:function(){return S}});var n=i(41460),o=i(38521),r=i(3189),s=i(83974);const c=s.ZP`
  mutation upsertInvoiceConfig($input: InvoiceConfigInput!) {
    upsertInvoiceConfig(input: $input) {
      id
      enabled
      templateString
    }
  }
`,l=s.ZP`
  query invoiceConfig {
    invoiceConfig {
      id
      enabled
      templateString
    }
  }
`,a=s.ZP`
  query invoices($input: InvoicesListInput) {
    invoices(input: $input) {
      items {
        id
        createdAt
        orderCode
        orderId
        customerEmail
        invoiceNumber
        downloadUrl
      }
      totalItems
    }
  }
`,d=s.ZP`
  query isInvoicePluginLicenseValid {
    isInvoicePluginLicenseValid
  }
`;var u=i(51694),g=i(21067),m=i(56258),h=i(70942);function v(e,t){1&e&&(u.TgZ(0,"small",12),u._uU(1," For commercial use of this plugin, please purchase a license at "),u.TgZ(2,"a",13),u._uU(3,"pinelab-plugins.com"),u.qZA(),u._uU(4,". "),u._UZ(5,"br"),u._uU(6," Already a user of this plugin? You might be applicable for a free license! Contact us at "),u.TgZ(7,"b"),u._uU(8,"plugins@pinelab.studio"),u.qZA(),u.qZA())}function p(e,t){if(1&e){const e=u.EpF();u.TgZ(0,"clr-accordion-content"),u.TgZ(1,"section",3),u.TgZ(2,"form",4),u.TgZ(3,"vdr-form-field",5),u.TgZ(4,"clr-checkbox-wrapper"),u._UZ(5,"input",6),u.qZA(),u.qZA(),u.TgZ(6,"vdr-form-field",7),u._UZ(7,"textarea",8),u.qZA(),u.TgZ(8,"button",1),u.NdJ("click",function(){return u.CHM(e),u.oxw().save()}),u._uU(9," Save "),u.qZA(),u.TgZ(10,"button",9),u.NdJ("click",function(){return u.CHM(e),u.oxw().testDownload()}),u._uU(11," Preview "),u.qZA(),u._UZ(12,"vdr-help-tooltip",10),u.qZA(),u._UZ(13,"br"),u.YNc(14,v,9,0,"small",11),u.qZA(),u.qZA()}if(2&e){const e=u.oxw();u.xp6(2),u.Q6J("formGroup",e.form),u.xp6(6),u.Q6J("disabled",e.form.invalid||e.form.pristine),u.xp6(6),u.Q6J("ngIf",!e.isLicenseValid)}}const f=function(e){return["/orders",e]};function Z(e,t){if(1&e&&(u.TgZ(0,"td",14),u._uU(1),u.qZA(),u.TgZ(2,"td",14),u._uU(3),u.ALo(4,"date"),u.qZA(),u.TgZ(5,"td",14),u._uU(6),u.qZA(),u.TgZ(7,"td",14),u.TgZ(8,"a",15),u._uU(9),u.qZA(),u.qZA(),u.TgZ(10,"td",14),u.TgZ(11,"a",16),u._UZ(12,"clr-icon",17),u.qZA(),u.qZA()),2&e){const e=t.item;u.xp6(1),u.Oqu(e.invoiceNumber),u.xp6(2),u.hij(" ",u.lcZ(4,6,e.createdAt)," "),u.xp6(3),u.Oqu(e.customerEmail),u.xp6(2),u.Q6J("routerLink",u.VKq(8,f,e.orderId)),u.xp6(1),u.hij(" ",e.orderCode," "),u.xp6(2),u.Q6J("href",e.downloadUrl,u.LSH)}}class b{constructor(e,t,i,n,r){this.formBuilder=e,this.dataService=t,this.changeDetector=i,this.notificationService=n,this.localStorageService=r,this.itemsPerPage=10,this.page=1,this.selectedInvoices=[],this.isSelected=e=>{var t;return!!(null===(t=this.selectedInvoices)||void 0===t?void 0:t.find(t=>t.id===e.id))},this.form=this.formBuilder.group({enabled:["enabled"],templateString:["templateString"]}),this.serverPath=(0,o.VC)()}ngOnInit(){return(0,r.mG)(this,void 0,void 0,function*(){this.dataService.query(l).mapStream(e=>e.invoiceConfig).subscribe(e=>{this.form.controls.enabled.setValue(null==e?void 0:e.enabled),this.form.controls.templateString.setValue(null==e?void 0:e.templateString)}),this.dataService.query(d).mapStream(e=>e.isInvoicePluginLicenseValid).subscribe(e=>this.isLicenseValid=e),yield this.getAllInvoices()})}getAllInvoices(){return(0,r.mG)(this,void 0,void 0,function*(){yield this.dataService.query(a,{input:{page:this.page,itemsPerPage:this.itemsPerPage}}).mapStream(e=>e.invoices).subscribe(e=>{this.invoicesList=e})})}save(){return(0,r.mG)(this,void 0,void 0,function*(){try{if(this.form.dirty){const e=this.form.value,{upsertInvoiceConfig:t}=yield this.dataService.mutate(c,{input:{enabled:e.enabled,templateString:e.templateString}}).toPromise();this.form.controls.enabled.setValue(t.enabled),this.form.controls.templateString.setValue(t.templateString)}this.form.markAsPristine(),this.changeDetector.markForCheck(),this.notificationService.success("common.notify-update-success",{entity:"InvoiceConfig"})}catch(e){this.notificationService.error("common.notify-update-error",{entity:"InvoiceConfig"})}})}downloadSelected(){return(0,r.mG)(this,void 0,void 0,function*(){try{const e=this.selectedInvoices.map(e=>e.invoiceNumber).join(","),t=yield fetch(`${this.serverPath}/invoices/download?nrs=${e}`,{headers:this.getHeaders()});if(!t.ok){const e=yield t.json();throw Error(null==e?void 0:e.message)}const i=yield t.blob();yield this.downloadBlob(i,"invoices.zip")}catch(e){console.error(e),this.notificationService.error(e.message)}})}setPageNumber(e){return(0,r.mG)(this,void 0,void 0,function*(){this.page=e,yield this.getAllInvoices()})}setItemsPerPage(e){return(0,r.mG)(this,void 0,void 0,function*(){this.page=1,this.itemsPerPage=Number(e),yield this.getAllInvoices()})}toggleSelect(e){this.isSelected(e)?this.selectedInvoices=this.selectedInvoices.filter(t=>t.id!==e.id):this.selectedInvoices.push(e)}toggleSelectAll(){var e;this.areAllSelected()?this.selectedInvoices=[]:this.selectedInvoices=(null===(e=this.invoicesList)||void 0===e?void 0:e.items)||[]}areAllSelected(){var e;return this.selectedInvoices.length===(null===(e=this.invoicesList)||void 0===e?void 0:e.items.length)}testDownload(){return(0,r.mG)(this,void 0,void 0,function*(){try{const e=this.form.value.templateString,t=yield fetch(`${this.serverPath}/invoices/preview`,{headers:Object.assign(Object.assign({},this.getHeaders()),{"Content-Type":"application/json"}),method:"POST",body:JSON.stringify({template:e})});if(!t.ok){const e=yield t.json();throw Error(null==e?void 0:e.message)}const i=yield t.blob();yield this.downloadBlob(i,"test-invoice.pdf",!0)}catch(e){console.error(e),this.notificationService.error(e.message)}})}getHeaders(){const e={},t=this.localStorageService.get("activeChannelToken");t&&(e["vendure-token"]=t);const i=this.localStorageService.get("authToken");return i&&(e.authorization=`Bearer ${i}`),e}downloadBlob(e,t,i=!1){return(0,r.mG)(this,void 0,void 0,function*(){const n=window.URL.createObjectURL(e),o=document.createElement("a");document.body.appendChild(o),o.setAttribute("hidden","true"),o.href=n,i||(o.download=t),o.setAttribute("target","_blank"),o.click()})}}b.\u0275fac=function(e){return new(e||b)(u.Y36(g.qu),u.Y36(o.DoR),u.Y36(u.sBO),u.Y36(o.gqp),u.Y36(o.n2A))},b.\u0275cmp=u.Xpm({type:b,selectors:[["invoices-component"]],decls:23,vars:7,consts:[[4,"clrIfExpanded"],[1,"btn","btn-primary",3,"disabled","click"],[3,"items","itemsPerPage","totalItems","currentPage","allSelected","isRowSelectedFn","pageChange","itemsPerPageChange","rowSelectChange","allSelectChange"],[1,"form-block"],[1,"form",3,"formGroup"],["label","Generate invoices on","for","enabled"],["type","checkbox","clrCheckbox","","formControlName","enabled"],["label","HTML template","for","templateString"],["id","templateString","type","text","formControlName","templateString",2,"height","300px","width","100%"],[1,"btn","btn-secondary",3,"click"],["content","Preview the HTML template. Uses the most recent placed order. Just a preview, it doesn't save any invoices!"],["style","color: red;",4,"ngIf"],[2,"color","red"],["href","https://pinelab-plugins.com/plugin/vendure-plugin-invoices/","target","_blank"],[1,"left","align-middle"],[3,"routerLink"],["target","_blank",3,"href"],["shape","download"]],template:function(e,t){1&e&&(u.TgZ(0,"clr-accordion"),u.TgZ(1,"clr-accordion-panel"),u.TgZ(2,"clr-accordion-title"),u._uU(3,"Settings"),u.qZA(),u.YNc(4,p,15,3,"clr-accordion-content",0),u.qZA(),u.qZA(),u._UZ(5,"hr"),u.TgZ(6,"section"),u.TgZ(7,"h2"),u._uU(8,"Created invoices"),u.qZA(),u.TgZ(9,"button",1),u.NdJ("click",function(){return t.downloadSelected()}),u._uU(10," Download "),u.qZA(),u.TgZ(11,"vdr-data-table",2),u.NdJ("pageChange",function(e){return t.setPageNumber(e)})("itemsPerPageChange",function(e){return t.setItemsPerPage(e)})("rowSelectChange",function(e){return t.toggleSelect(e)})("allSelectChange",function(){return t.toggleSelectAll()}),u.TgZ(12,"vdr-dt-column"),u._uU(13,"Invoice nr."),u.qZA(),u.TgZ(14,"vdr-dt-column"),u._uU(15,"Created"),u.qZA(),u.TgZ(16,"vdr-dt-column"),u._uU(17,"Customer"),u.qZA(),u.TgZ(18,"vdr-dt-column"),u._uU(19,"Order"),u.qZA(),u.TgZ(20,"vdr-dt-column"),u._uU(21,"Download"),u.qZA(),u.YNc(22,Z,13,10,"ng-template"),u.qZA(),u.qZA()),2&e&&(u.xp6(9),u.Q6J("disabled",0==(null==t.selectedInvoices?null:t.selectedInvoices.length)),u.xp6(2),u.Q6J("items",null==t.invoicesList?null:t.invoicesList.items)("itemsPerPage",t.itemsPerPage)("totalItems",null==t.invoicesList?null:t.invoicesList.totalItems)("currentPage",t.page)("allSelected",t.areAllSelected())("isRowSelectedFn",t.isSelected))},directives:[m.bZL,m.twP,m.GmI,m.dxz,m.UJ5,m.Nz$,m.DbV,o.Qj_,o.Egy,m.r6y,g._Y,g.JL,g.sg,o.hgI,m.PEh,o.y_K,g.Wl,m.KKC,g.JJ,g.u,g.Fj,o.opf,h.O5,n.yS,m.qvL],pipes:[h.uU],encapsulation:2});class S{}S.\u0275fac=function(e){return new(e||S)},S.\u0275mod=u.oAB({type:S}),S.\u0275inj=u.cJS({providers:[],imports:[[o.m81,n.Bz.forChild([{path:"",pathMatch:"full",component:b,data:{breadcrumb:"Invoices"}}])]]})}}]);
//# sourceMappingURL=668-es2015.5e5bb4330462581e3602.js.map