{"version":3,"mappings":"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","names":["_","g","Z","S","I","e","constructor","t","i","o","n","u","this","P","h","selectedInvoices","find","U","id","form","formBuilder","group","enabled","templateString","serverPath","c","ngOnInit","dataService","query","mapStream","invoiceConfig","subscribe","controls","setValue","isInvoicePluginLicenseValid","isLicenseValid","getAllInvoices","input","page","itemsPerPage","invoices","invoicesList","save","dirty","value","upsertInvoiceConfig","mutate","toPromise","markAsPristine","changeDetector","markForCheck","notificationService","success","entity","error","downloadSelected","map","invoiceNumber","join","fetch","headers","getHeaders","ok","json","Error","message","blob","downloadBlob","console","setPageNumber","setItemsPerPage","Number","toggleSelect","isSelected","filter","push","toggleSelectAll","areAllSelected","items","length","testDownload","Object","method","body","JSON","stringify","template","localStorageService","get","authorization","window","URL","createObjectURL","document","createElement","appendChild","setAttribute","href","download","click","v","selectors","m","imports","f","path","pathMatch","component","data","breadcrumb"],"sources":["webpack:///src/extensions/37d7092441b912af19f217975c0ca13f1a2e989bbd1decf5cb96dd931b181b30/queries.graphql.ts","webpack:///src/extensions/37d7092441b912af19f217975c0ca13f1a2e989bbd1decf5cb96dd931b181b30/invoices.component.ts","webpack:///src/extensions/37d7092441b912af19f217975c0ca13f1a2e989bbd1decf5cb96dd931b181b30/invoices.module.ts"],"sourcesContent":["import gql from 'graphql-tag';\n\nexport const upsertConfigMutation = gql`\n  mutation upsertInvoiceConfig($input: InvoiceConfigInput!) {\n    upsertInvoiceConfig(input: $input) {\n      id\n      enabled\n      templateString\n    }\n  }\n`;\n\nexport const getConfigQuery = gql`\n  query invoiceConfig {\n    invoiceConfig {\n      id\n      enabled\n      templateString\n    }\n  }\n`;\n\nexport const getAllInvoicesQuery = gql`\n  query invoices($input: InvoicesListInput) {\n    invoices(input: $input) {\n      items {\n        id\n        createdAt\n        orderCode\n        orderId\n        customerEmail\n        invoiceNumber\n        downloadUrl\n      }\n      totalItems\n    }\n  }\n`;\n\nexport const isInvoicePluginLicenseValid = gql`\n  query isInvoicePluginLicenseValid {\n    isInvoicePluginLicenseValid\n  }\n`;\n","import { ChangeDetectorRef, Component, OnInit } from '@angular/core';\nimport { FormBuilder, FormGroup } from '@angular/forms';\nimport {\n  DataService,\n  getServerLocation,\n  LocalStorageService,\n  NotificationService,\n} from '@vendure/admin-ui/core';\nimport {\n  getAllInvoicesQuery,\n  getConfigQuery,\n  isInvoicePluginLicenseValid,\n  upsertConfigMutation,\n} from './queries.graphql';\nimport {\n  Invoice,\n  InvoiceConfig,\n  InvoiceConfigQuery,\n  InvoiceList,\n  InvoicesQuery,\n  InvoicesQueryVariables,\n  IsInvoicePluginLicenseValidQuery,\n  UpsertInvoiceConfigMutation,\n  UpsertInvoiceConfigMutationVariables,\n} from './generated/graphql';\n\n@Component({\n  selector: 'invoices-component',\n  template: `\n    <clr-accordion>\n      <clr-accordion-panel>\n        <clr-accordion-title>Settings</clr-accordion-title>\n        <clr-accordion-content *clrIfExpanded>\n          <section class=\"form-block\">\n            <form class=\"form\" [formGroup]=\"form\">\n              <vdr-form-field label=\"Generate invoices on\" for=\"enabled\">\n                <clr-checkbox-wrapper>\n                  <input\n                    type=\"checkbox\"\n                    clrCheckbox\n                    formControlName=\"enabled\"\n                  />\n                </clr-checkbox-wrapper>\n              </vdr-form-field>\n              <vdr-form-field label=\"HTML template\" for=\"templateString\">\n                <textarea\n                  id=\"templateString\"\n                  type=\"text\"\n                  formControlName=\"templateString\"\n                  style=\"height: 300px; width: 100%;\"\n                ></textarea>\n              </vdr-form-field>\n              <button\n                class=\"btn btn-primary\"\n                (click)=\"save()\"\n                [disabled]=\"form.invalid || form.pristine\"\n              >\n                Save\n              </button>\n              <button class=\"btn btn-secondary\" (click)=\"testDownload()\">\n                Preview\n              </button>\n              <vdr-help-tooltip\n                content=\"Preview the HTML template. Uses the most recent placed order. Just a preview, it doesn't save any invoices!\"\n              ></vdr-help-tooltip>\n            </form>\n            <br />\n            <small *ngIf=\"!isLicenseValid\" style=\"color: red;\">\n              For commercial use of this plugin, please purchase a license at\n              <a\n                href=\"https://pinelab-plugins.com/plugin/vendure-plugin-invoices/\"\n                target=\"_blank\"\n                >pinelab-plugins.com</a\n              >.\n              <br />\n              Already a user of this plugin? You might be applicable for a free\n              license! Contact us at <b>plugins@pinelab.studio</b>\n            </small>\n          </section>\n        </clr-accordion-content>\n      </clr-accordion-panel>\n    </clr-accordion>\n\n    <hr />\n    <section>\n      <h2>Created invoices</h2>\n      <button\n        class=\"btn btn-primary\"\n        (click)=\"downloadSelected()\"\n        [disabled]=\"selectedInvoices?.length == 0\"\n      >\n        Download\n      </button>\n      <vdr-data-table\n        [items]=\"invoicesList?.items\"\n        [itemsPerPage]=\"itemsPerPage\"\n        [totalItems]=\"invoicesList?.totalItems\"\n        [currentPage]=\"page\"\n        (pageChange)=\"setPageNumber($event)\"\n        (itemsPerPageChange)=\"setItemsPerPage($event)\"\n        [allSelected]=\"areAllSelected()\"\n        [isRowSelectedFn]=\"isSelected\"\n        (rowSelectChange)=\"toggleSelect($event)\"\n        (allSelectChange)=\"toggleSelectAll()\"\n      >\n        <vdr-dt-column>Invoice nr.</vdr-dt-column>\n        <vdr-dt-column>Created</vdr-dt-column>\n        <vdr-dt-column>Customer</vdr-dt-column>\n        <vdr-dt-column>Order</vdr-dt-column>\n        <vdr-dt-column>Download</vdr-dt-column>\n        <ng-template let-invoice=\"item\">\n          <td class=\"left align-middle\">{{ invoice.invoiceNumber }}</td>\n          <td class=\"left align-middle\">\n            {{ invoice.createdAt | date }}\n          </td>\n          <td class=\"left align-middle\">{{ invoice.customerEmail }}</td>\n          <td class=\"left align-middle\">\n            <a [routerLink]=\"['/orders', invoice.orderId]\">\n              {{ invoice.orderCode }}\n            </a>\n          </td>\n          <td class=\"left align-middle\">\n            <a [href]=\"invoice.downloadUrl\" target=\"_blank\">\n              <clr-icon shape=\"download\"></clr-icon>\n            </a>\n          </td>\n        </ng-template>\n      </vdr-data-table>\n    </section>\n  `,\n})\nexport class InvoicesComponent implements OnInit {\n  form: FormGroup;\n  invoicesList: InvoiceList | undefined;\n  itemsPerPage = 10;\n  page = 1;\n  selectedInvoices: Invoice[] = [];\n  serverPath: string;\n  isLicenseValid: boolean | undefined | null;\n\n  constructor(\n    private formBuilder: FormBuilder,\n    protected dataService: DataService,\n    private changeDetector: ChangeDetectorRef,\n    private notificationService: NotificationService,\n    private localStorageService: LocalStorageService\n  ) {\n    this.form = this.formBuilder.group({\n      enabled: ['enabled'],\n      templateString: ['templateString'],\n    });\n    this.serverPath = getServerLocation();\n  }\n\n  async ngOnInit(): Promise<void> {\n    this.dataService\n      .query<InvoiceConfigQuery>(getConfigQuery)\n      .mapStream((d) => d.invoiceConfig)\n      .subscribe((config) => {\n        this.form.controls['enabled'].setValue(config?.enabled);\n        this.form.controls['templateString'].setValue(config?.templateString);\n      });\n    // Validate license\n    this.dataService\n      .query<IsInvoicePluginLicenseValidQuery>(isInvoicePluginLicenseValid)\n      .mapStream((l) => l.isInvoicePluginLicenseValid)\n      .subscribe((result) => (this.isLicenseValid = result));\n    await this.getAllInvoices();\n  }\n\n  async getAllInvoices(): Promise<void> {\n    await this.dataService\n      .query<InvoicesQuery, InvoicesQueryVariables>(getAllInvoicesQuery, {\n        input: {\n          page: this.page,\n          itemsPerPage: this.itemsPerPage,\n        },\n      })\n      .mapStream((r) => r.invoices)\n      .subscribe((result) => {\n        this.invoicesList = result;\n      });\n  }\n\n  async save() {\n    try {\n      if (this.form.dirty) {\n        const formValue = this.form.value;\n        const { upsertInvoiceConfig: result } = await this.dataService\n          .mutate<\n            UpsertInvoiceConfigMutation,\n            UpsertInvoiceConfigMutationVariables\n          >(upsertConfigMutation, {\n            input: {\n              enabled: formValue.enabled,\n              templateString: formValue.templateString,\n            },\n          })\n          .toPromise();\n        this.form.controls['enabled'].setValue(result.enabled);\n        this.form.controls['templateString'].setValue(result.templateString);\n      }\n      this.form.markAsPristine();\n      this.changeDetector.markForCheck();\n      this.notificationService.success('common.notify-update-success', {\n        entity: 'InvoiceConfig',\n      });\n    } catch (e) {\n      this.notificationService.error('common.notify-update-error', {\n        entity: 'InvoiceConfig',\n      });\n    }\n  }\n\n  async downloadSelected(): Promise<void> {\n    try {\n      const nrs = this.selectedInvoices.map((i) => i.invoiceNumber).join(',');\n      const res = await fetch(\n        `${this.serverPath}/invoices/download?nrs=${nrs}`,\n        {\n          headers: this.getHeaders(),\n        }\n      );\n      if (!res.ok) {\n        const json = await res.json();\n        throw Error(json?.message);\n      }\n      const blob = await res.blob();\n      await this.downloadBlob(blob, 'invoices.zip');\n    } catch (err) {\n      console.error(err);\n      this.notificationService.error(err.message);\n    }\n  }\n\n  async setPageNumber(page: number) {\n    this.page = page;\n    await this.getAllInvoices();\n  }\n\n  async setItemsPerPage(nrOfItems: number) {\n    this.page = 1;\n    this.itemsPerPage = Number(nrOfItems);\n    await this.getAllInvoices();\n  }\n\n  isSelected = (row: Invoice): boolean => {\n    return !!this.selectedInvoices?.find((selected) => selected.id === row.id);\n  };\n\n  toggleSelect(row: Invoice): void {\n    if (this.isSelected(row)) {\n      this.selectedInvoices = this.selectedInvoices.filter(\n        (s) => s.id !== row.id\n      );\n    } else {\n      this.selectedInvoices.push(row);\n    }\n  }\n\n  toggleSelectAll() {\n    if (this.areAllSelected()) {\n      this.selectedInvoices = [];\n    } else {\n      this.selectedInvoices = this.invoicesList?.items || [];\n    }\n  }\n\n  areAllSelected(): boolean {\n    return this.selectedInvoices.length === this.invoicesList?.items.length;\n  }\n\n  async testDownload() {\n    try {\n      const template = this.form.value.templateString;\n      const res = await fetch(`${this.serverPath}/invoices/preview`, {\n        headers: {\n          ...this.getHeaders(),\n          'Content-Type': 'application/json',\n        },\n        method: 'POST',\n        body: JSON.stringify({ template }),\n      });\n      if (!res.ok) {\n        const json = await res.json();\n        throw Error(json?.message);\n      }\n      const blob = await res.blob();\n      await this.downloadBlob(blob, 'test-invoice.pdf', true);\n    } catch (err) {\n      console.error(err);\n      this.notificationService.error(err.message);\n    }\n  }\n\n  private getHeaders(): Record<string, string> {\n    const headers: Record<string, string> = {};\n    const channelToken = this.localStorageService.get('activeChannelToken');\n    if (channelToken) {\n      headers['vendure-token'] = channelToken;\n    }\n    const authToken = this.localStorageService.get('authToken');\n    if (authToken) {\n      headers.authorization = `Bearer ${authToken}`;\n    }\n    return headers;\n  }\n\n  private async downloadBlob(\n    blob: Blob,\n    fileName: string,\n    openInNewTab = false\n  ): Promise<void> {\n    const blobUrl = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    document.body.appendChild(a);\n    a.setAttribute('hidden', 'true');\n    a.href = blobUrl;\n    if (!openInNewTab) {\n      a.download = fileName;\n    }\n    a.setAttribute('target', '_blank');\n    a.click();\n  }\n}\n","import { NgModule } from '@angular/core';\nimport { RouterModule } from '@angular/router';\nimport { SharedModule } from '@vendure/admin-ui/core';\nimport { InvoicesComponent } from './invoices.component';\n\n@NgModule({\n  imports: [\n    SharedModule,\n    RouterModule.forChild([\n      {\n        path: '',\n        pathMatch: 'full',\n        component: InvoicesComponent,\n        data: { breadcrumb: 'Invoices' },\n      },\n    ]),\n  ],\n  providers: [],\n  declarations: [InvoicesComponent],\n})\nexport class InvoicesModule {}\n"]}